{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø–æ–ª–∏–≤—É</title>
    <link rel="stylesheet" href="{% static 'css/interactive_board.css' %}">
    <link rel="stylesheet" href="{% static 'css/nav.css' %}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
</head>
<body>
    <button class="menu-btn" id="menuBtn">
        ‚ò∞
    </button>
    
    <nav class="side-nav" id="sideNav">
        <h3 class="menu-title">–ê–≥—Ä–æ–ü–æ–ª–∏–≤</h3>
        <button class="close-btn" id="closeBtn">&times;</button>
        <ul>
        <li><a href="{% url 'home' %}"><span class="icon material-symbols-outlined">home</span>  –ì–æ–ª–æ–≤–Ω–∞</a></li>
        <li><a href="{% url 'catalog' %}"><span class="icon material-symbols-outlined">local_mall</span>  –ö–∞—Ç–∞–ª–æ–≥</a></li>
        <li><a href="{% url 'articles' %}"><span class="icon material-symbols-outlined">article</span>  –°—Ç–∞—Ç—Ç—ñ</a></li>
        <li><a href="{% url 'services' %}" ><span class="icon material-symbols-outlined">home_repair_service</span>  –ü–æ—Å–ª—É–≥–∏</a></li>
        {% if request.user.is_authenticated %}
            <li><a href="{% url 'interactive_board' %}" class="now"><span class="icon material-symbols-outlined">format_paint</span>  –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤ –¥–æ—à–∫–∞</a></li>
            <li><a href="{% url 'cart' %}"><span class="icon material-symbols-outlined">garden_cart</span>  –ö–æ—à–∏–∫</a></li>
            <li><a href="{% url 'logout' %}"><span class="icon material-symbols-outlined">logout</span>  –í–∏–π—Ç–∏</a></li>
        {% else %}
            <li><a href="{% url 'login' %}"><span class="icon material-symbols-outlined">logout</span>  –í—Ö—ñ–¥</a></li>
        {% endif %}
        </ul>
    </nav>
    <div class="overlay" id="overlay"></div>
    
    <div class="effects-container">
        <div class="color-overlay"></div>
        <div class="pulse-effect"></div>
        <div class="wave-edges"></div>
        <div class="fireflies">
            <div class="firefly" style="top: 20%; left: 10%;"></div>
            <div class="firefly" style="top: 80%; left: 90%;"></div>
            <div class="firefly" style="top: 50%; left: 45%;"></div>
            <div class="firefly" style="top: 10%; left: 70%;"></div>
            <div class="firefly" style="top: 65%; left: 30%;"></div>
        </div>
    </div>
    <div class="builder-container">

        <div class="inventory-panel">
            <h2>üõ†Ô∏è –î–æ—Å—Ç—É–ø–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏</h2>

            <div id="items-list" class="item-list">
                {% for item in items %}
                    <div class="draggable-item"
                        draggable="true"
                        data-id="{{ item.id }}"
                        data-type="item"
                        data-name="{{ item.name }}"
                        data-price="{{ item.price|stringformat:"f" }}"
                        data-category="{{ item.category }}"
                        data-is-linear="{% if item.category == 'hoses' %}true{% else %}false{% endif %}"
                        data-image-url="{% if item.image %}{% static item.image %}{% else %}{% static 'images/default_icon.png' %}{% endif %}">
                        
                        <img src="{% if item.image %}{% static item.image %}{% else %}{% static 'images/default_icon.png' %}{% endif %}" 
                             alt="{{ item.name }}" class="item-icon">
                        <span class="item-label">
                            {{ item.name }} 
                            ({% if item.category == 'hoses' %}{{ item.price }} ‚Ç¥/–º{% else %}{{ item.price }} ‚Ç¥{% endif %})
                        </span>
                    </div>
                {% endfor %}
            </div>

            <h3>üå± –†–æ—Å–ª–∏–Ω–∏</h3>
            <div id="plants-list" class="item-list">
            </div>

            <h3>üí° –ü–æ—Ä–∞–¥–∞</h3>
            <p style="font-size:0.9rem; color:rgba(242, 255, 199, 0.7);">
                –†–æ–∑–º—ñ—â—É–π—Ç–µ —à–ª–∞–Ω–≥–∏ –±—ñ–ª—è —Ä–æ—Å–ª–∏–Ω, —â–æ–± –ø–æ–∫—Ä–∏—Ç–∏ –≤—Å—é –≥—Ä—è–¥–∫—É. 
                –í–∏—Å–æ–∫—ñ —Ä–æ—Å–ª–∏–Ω–∏ —Å—Ç–∞–≤—Ç–µ –∑–∑–∞–¥—É, –Ω–∏–∑—å–∫—ñ ‚Äî —Å–ø–µ—Ä–µ–¥—É. 
                –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ñ —Ä–æ—Å–ª–∏–Ω–∏ –º–æ–∂–Ω–∞ –ø–æ—î–¥–Ω—É–≤–∞—Ç–∏ –º—ñ–∂ —Ç–æ–≤–∞—Ä–∞–º–∏ –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ –ø–æ–ª–∏–≤—É.
            </p>

        </div>

        <div class="design-canvas-wrapper">
            <h2>üå± –†–æ–±–æ—á–∞ –æ–±–ª–∞—Å—Ç—å (–ü–æ–ª–µ)</h2>
            <div id="design-canvas"></div>
            <button id="clear-canvas">–û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ª–µ</button>
        </div>

        <div class="cost-panel">
            <h2>üí∞ –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–∞—Ä—Ç–æ—Å—Ç—ñ</h2>
            <div id="summary-items">
                <p>–ï–ª–µ–º–µ–Ω—Ç–∏ –ø–æ–∫–∏ —â–æ –Ω–µ –≤–∏–±—Ä–∞–Ω–æ.</p>
            </div>
            <h3>–ó–∞–≥–∞–ª—å–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å: <span id="total-cost">0.00</span> ‚Ç¥</h3>
            <form method="post" action="{% url 'add_board_item' %}" id="add-to-cart-form">
                {% csrf_token %}
                
                <input type="hidden" name="board_data" id="board-data-input">
                
                <button type="submit" id="add-to-cart-btn" class="checkout-btn">üõí –î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</button>
            </form>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const menuBtn = document.getElementById("menuBtn");
            const sideNav = document.getElementById("sideNav");
            const closeBtn = document.getElementById("closeBtn");
            const overlay = document.getElementById("overlay");
    
            menuBtn.addEventListener("click", () => {
                sideNav.classList.add("active");
                overlay.classList.add("active");
            });
    
            closeBtn.addEventListener("click", () => {
                sideNav.classList.remove("active");
                overlay.classList.remove("active");
            });
    
            overlay.addEventListener("click", () => {
                sideNav.classList.remove("active");
                overlay.classList.remove("active");
            });
    
            const canvas = document.getElementById('design-canvas');
        const summaryItems = document.getElementById('summary-items');
        const totalCostDisplay = document.getElementById('total-cost');
        const clearCanvasBtn = document.getElementById('clear-canvas');
        
        // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —Ñ–æ—Ä–º–∏
        const addToCartForm = document.getElementById('add-to-cart-form');
        const boardDataInput = document.getElementById('board-data-input');
        const addToCartBtn = document.getElementById('add-to-cart-btn');
        
        const plants = [
            {id: 'plant1', name: '–ü—à–µ–Ω–∏—Ü—è', image: '{% static "images/plant1.png" %}'},
            {id: 'plant2', name: '–ü–æ–º—ñ–¥–æ—Ä', image: '{% static "images/plant2.png" %}'},
            {id: 'plant3', name: '–°–∞–ª–∞—Ç', image: '{% static "images/plant3.png" %}'},
            {id: 'plant4', name: '–ú–æ—Ä–∫–≤–∞', image: '{% static "images/plant4.png" %}'},
        ];

        const plantsList = document.getElementById('plants-list');

        plants.forEach(p => {
            const el = document.createElement('div');
            el.className = 'draggable-item';
            el.draggable = true;
            el.dataset.type = 'plant';
            el.dataset.name = p.name;
            el.dataset.id = p.id;
            el.dataset.imageUrl = p.image;

            el.innerHTML = `<img src="${p.image}" class="item-icon"> <span class="item-label">${p.name}</span>`;
            plantsList.appendChild(el);
        });

        const allDraggables = document.querySelectorAll('.draggable-item');

        let draggedElementData = null;
        let placedElements = []; // –¢—É—Ç –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤—Å—ñ —Ä–æ–∑–º—ñ—â–µ–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏

        allDraggables.forEach(item => {
            item.addEventListener('dragstart', e => {
                draggedElementData = {...e.target.dataset};

                if (draggedElementData.type === 'item') {
                    draggedElementData.price = parseFloat(draggedElementData.price);
                } else {
                    draggedElementData.price = 0; 
                }

                e.dataTransfer.setData('text/plain', JSON.stringify(draggedElementData));
            });
            item.addEventListener('dragend', () => {}); 
        });

        canvas.addEventListener('dragover', e => e.preventDefault());


        canvas.addEventListener('drop', e => {
            e.preventDefault();

            if (!draggedElementData) return;

            let itemQuantity = 1;
            if (draggedElementData.type === 'item' && draggedElementData.isLinear === 'true') {
                const inputLength = prompt(`–í–≤–µ–¥—ñ—Ç—å –¥–æ–≤–∂–∏–Ω—É —à–ª–∞–Ω–≥–∞ "${draggedElementData.name}" —É –º–µ—Ç—Ä–∞—Ö:`, 10);
                const qty = parseFloat(inputLength);

                if (isNaN(qty) || qty <= 0) {
                    alert("–ù–µ–¥—ñ–π—Å–Ω–∞ –¥–æ–≤–∂–∏–Ω–∞. –°–∫–∏–¥–∞–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ.");
                    draggedElementData = null; 
                    return; 
                }
                itemQuantity = qty;
            }
            draggedElementData.quantity = itemQuantity;

            const newEl = document.createElement('div');
            newEl.className = 'design-element';
            newEl.style.position = 'absolute';
            const rect = canvas.getBoundingClientRect();
            // –ü–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è
            newEl.style.left = (e.clientX - rect.left - 25) + 'px';
            newEl.style.top = (e.clientY - rect.top - 25) + 'px';

            // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –≤–º—ñ—Å—Ç—É –µ–ª–µ–º–µ–Ω—Ç–∞ –Ω–∞ –∫–∞–Ω–≤—ñ
            if (draggedElementData.type === 'plant') {
                newEl.innerHTML = `<img src="${draggedElementData.imageUrl}" alt="${draggedElementData.name}">`;
                newEl.style.width = '50px';
                newEl.style.height = '50px';
            } else if (draggedElementData.type === 'item') {
                if (draggedElementData.isLinear === 'true') {
                    newEl.classList.add('hose');
                    newEl.innerText = `${itemQuantity} –º`;
                    newEl.style.width = '100px';
                    newEl.style.height = '15px';
                } else {
                    newEl.innerHTML = `<img src="${draggedElementData.imageUrl}" alt="${draggedElementData.name}">`;
                    newEl.style.width = '50px';
                    newEl.style.height = '50px';
                }
            }

            newEl.dataset.id = draggedElementData.id;
            newEl.dataset.type = draggedElementData.type;

            newEl.dataset.price = draggedElementData.price || 0;
            newEl.dataset.quantity = draggedElementData.quantity || 1;

            canvas.appendChild(newEl);

            // ‚ö†Ô∏è –î–æ–¥–∞—î–º–æ –µ–ª–µ–º–µ–Ω—Ç —É –º–∞—Å–∏–≤ placedElements
            placedElements.push({...draggedElementData, element: newEl, quantity: itemQuantity});
            updateCalculations();

            makeMovable(newEl);
            draggedElementData = null;
        });

        // –§–£–ù–ö–¶–Ü–á –†–£–•–£ –¢–ê –†–û–ó–†–ê–•–£–ù–ö–£ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω
        function makeMovable(el) {
            let isDown = false;
            let offset = [0,0];
            el.addEventListener('mousedown', e => { 
                isDown = true; 
                offset = [el.offsetLeft - e.clientX, el.offsetTop - e.clientY]; 
                el.style.zIndex = 20; 
            });
            document.addEventListener('mouseup', () => { 
                isDown = false; 
                el.style.zIndex = 10; 
            });
            document.addEventListener('mousemove', e => {
                if (!isDown) return;
                let newX = e.clientX + offset[0];
                let newY = e.clientY + offset[1];
                const canvasRect = canvas.getBoundingClientRect();
                newX = Math.max(0, Math.min(newX, canvasRect.width - el.offsetWidth));
                newY = Math.max(0, Math.min(newY, canvasRect.height - el.offsetHeight));
                el.style.left = newX + 'px';
                el.style.top = newY + 'px';
            });
        }
        

        function updateCalculations() {
            let total = 0;
            let html = '';

            // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –ª–∏—à–µ —Ç–æ–≤–∞—Ä–∏ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É (–Ω–µ —Ä–æ—Å–ª–∏–Ω–∏)
            const itemsForCalculation = placedElements.filter(p => p.type === 'item');

            if (!itemsForCalculation.length) { 
                html = '<p>–ï–ª–µ–º–µ–Ω—Ç–∏ –ø–æ–∫–∏ —â–æ –Ω–µ –≤–∏–±—Ä–∞–Ω–æ.</p>'; 
                // –í–∏–º–∏–∫–∞—î–º–æ –∫–Ω–æ–ø–∫—É, —è–∫—â–æ –Ω–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤
                if(addToCartBtn) addToCartBtn.disabled = true;
            } else {
                itemsForCalculation.forEach((item) => {
                    const price = parseFloat(item.price) || 0;
                    const isLinear = item.isLinear === 'true';
                    const quantity = parseFloat(item.quantity) || 1;

                    const cost = isLinear ? price * quantity : price * quantity; // –ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –¥–ª—è –≤—Å—ñ—Ö —Ç–æ–≤–∞—Ä—ñ–≤
                    total += cost;

                    // –ü–æ—à—É–∫ —ñ–Ω–¥–µ–∫—Å—É —É placedElements –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è            
                    const placedIndex = placedElements.findIndex(p => p.element === item.element);

                    html += `<p data-index="${placedIndex}">${item.name} (${quantity}${isLinear ? ' –º' : ''}) - ${cost.toFixed(2)} ‚Ç¥ <span class="remove-item-btn" data-index="${placedIndex}">[X]</span></p>`;
                });
                if(addToCartBtn) addToCartBtn.disabled = false;
            }
            summaryItems.innerHTML = html;
            totalCostDisplay.innerText = total.toFixed(2);
            document.querySelectorAll('.remove-item-btn').forEach(btn => btn.addEventListener('click', removeItem));
        }

        function removeItem(e) {
            const idx = parseInt(e.target.dataset.index);
            if(placedElements[idx] && placedElements[idx].element) {
                placedElements[idx].element.remove();
            }
            // –í–∏–¥–∞–ª—è—î–º–æ —Ç–∞ –æ–Ω–æ–≤–ª—é—î–º–æ
            placedElements.splice(idx, 1);
            updateCalculations();
        }

        clearCanvasBtn.addEventListener('click', () => { canvas.innerHTML=''; placedElements=[]; updateCalculations(); });
        

        if(addToCartForm) {
            addToCartForm.addEventListener('submit', (e) => {
                // 1. –§—ñ–ª—å—Ç—Ä—É—î–º–æ –ª–∏—à–µ –¢–û–í–ê–†–ò
                const itemsToCart = placedElements
                    .filter(p => p.type === 'item')
                    .map(p => ({
                        id: p.id,
                        quantity: parseFloat(p.quantity) || 1, 
                    }));

                if (itemsToCart.length === 0) {
                    e.preventDefault(); // –ó—É–ø–∏–Ω—è—î–º–æ –≤—ñ–¥–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º–∏
                    alert("–ù–∞ –ø–æ–ª—ñ –Ω–µ–º–∞—î –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –¥–ª—è –ø–æ–ª–∏–≤—É –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤ –∫–æ—à–∏–∫!");
                    return;
                }
                const dataToSend = JSON.stringify(itemsToCart);

                boardDataInput.value = dataToSend;
            });
        }
        updateCalculations();
    });
    </script>
</body>
</html>