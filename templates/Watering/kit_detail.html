{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/kit_det.css' %}">
    <title>Деталі сету</title>
</head>
<body>
    <h1>{{ kit.name }}</h1>
    <p>{{ kit.description }}</p>

    {% if kit.image %}
        <img src="{{ kit.image.url }}" alt="{{ kit.name }}">
    {% endif %}

    <h2>Склад набору</h2>

    <ul>
        {% for kit_item in kit_items %} 
            <li>
                <a href="{% url 'item_detail' kit_item.item.id %}">
                    {{ kit_item.item.name }} — {{ kit_item.quantity }} шт.<br>
                    <small>{{ kit_item.item.description }}</small>
                </a>
            </li>
        {% empty %}
            <li>У цьому наборі поки немає товарів.</li>
        {% endfor %}
    </ul>
    

    <p class="price">{{ kit.price }} грн</p>
    <br>

    <button class="btn buy-btn" onclick="openPurchaseModal('buy')">Купити набір</button>
    <button class="btn-cart" onclick="openPurchaseModal('cart')">Додати в кошик</button>

    <div class="modal" id="purchaseModal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closePurchaseModal()">&times;</span>
            <h2 id="modalTitle">Підтвердження дії</h2> 
            <p><strong>{{ kit.name }}</strong></p>
            <p id="unitPriceContainer">Ціна: <strong id="unitPriceDisplay">{{ kit.price }}</strong> грн</p>

            <label for="actionQty">Кількість наборів:</label>
            <input type="number" id="actionQty" min="1" value="1">

            <div id="promoContainer">
                <label for="actionPromo">Промокод (для покупки):</label>
                <input type="text" id="actionPromo" placeholder="Введіть код">
            </div>

            <p id="totalPriceContainer">
                Всього: 
                <strong id="actionTotal">{{ kit.price }}</strong> грн
            </p>

            <form id="purchaseForm" method="POST">
                {% csrf_token %}
                <input type="hidden" name="quantity" id="actionQtyHidden" value="1">
                <input type="hidden" name="promo_code" id="actionPromoHidden" value="">
                
                <button type="submit" class="btn-confirm" id="btnConfirmBuy">Придбати</button>
                <button type="submit" class="btn-confirm" id="btnConfirmCart" style="display: none;">Додати в кошик</button>
            </form>
        </div>
    </div>

    <script>
        const purchaseModal = document.getElementById("purchaseModal");
        const purchaseForm = document.getElementById("purchaseForm");
        const modalTitle = document.getElementById("modalTitle");
        const btnConfirmBuy = document.getElementById("btnConfirmBuy");
        const btnConfirmCart = document.getElementById("btnConfirmCart");
        const promoContainer = document.getElementById("promoContainer");
        const totalPriceContainer = document.getElementById("totalPriceContainer");

        const actionQty = document.getElementById("actionQty");
        const actionPromo = document.getElementById("actionPromo");
        const actionTotal = document.getElementById("actionTotal");
        const actionQtyHidden = document.getElementById("actionQtyHidden");
        const actionPromoHidden = document.getElementById("actionPromoHidden");
        const unitPriceDisplay = document.getElementById("unitPriceDisplay");

        const unitPrice = parseFloat('{{ kit.price }}');
        
        // Константи для URL-адрес
        const BUY_URL = "{% url 'buy_kit' kit.id %}";
        const CART_URL = "{% url 'add_kit_to_cart' kit.id %}";


        function updateHiddenFields() {
            // Оновлюємо приховані поля для відправки на бекенд
            let quantity = Math.max(parseInt(actionQty.value) || 1, 1);
            actionQty.value = quantity; // Відображаємо коректне значення
            actionQtyHidden.value = quantity;
            actionPromoHidden.value = actionPromo.value.trim();
        }

        function updateApproximateTotal() {
            // Оновлюємо лише орієнтовну суму (без знижки)
            let quantity = Math.max(parseInt(actionQty.value) || 1, 1);
            actionTotal.innerText = (unitPrice * quantity).toFixed(2);
        }

        function openPurchaseModal(actionType) {
            updateApproximateTotal(); // Початковий розрахунок без знижки

            if (actionType === 'buy') {
                modalTitle.innerText = "Підтвердження покупки";
                purchaseForm.action = BUY_URL;
                btnConfirmBuy.style.display = 'block';
                btnConfirmCart.style.display = 'none';
                promoContainer.style.display = 'block'; // Показати промокод
                totalPriceContainer.style.display = 'block'; // Показати загальну суму
            } else if (actionType === 'cart') {
                modalTitle.innerText = "Додати набір до кошика";
                purchaseForm.action = CART_URL;
                btnConfirmBuy.style.display = 'none';
                btnConfirmCart.style.display = 'block';
                promoContainer.style.display = 'none'; // Сховати промокод для кошика
                // При додаванні в кошик промокод не потрібен, але покажемо орієнтовну суму для інформації
                totalPriceContainer.style.display = 'block'; 
            }

            purchaseModal.style.display = 'flex';
        }
        
        function closePurchaseModal() { purchaseModal.style.display = 'none'; }

        // Події: оновлюють приховані поля та орієнтовну суму
        actionQty.addEventListener("input", () => {
            updateHiddenFields();
            updateApproximateTotal();
        });
        actionPromo.addEventListener("input", updateHiddenFields); // Промокод оновлює лише приховане поле
        
        // Оновлюємо приховані поля безпосередньо перед відправкою форми, щоб захопити останні зміни
        purchaseForm.addEventListener('submit', updateHiddenFields);
        
    </script>
</body>
</html>